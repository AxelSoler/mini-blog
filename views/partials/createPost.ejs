<section class="mb-4 flex flex-col items-center" x-data="createPostModal()">
  <button
    @click="showModal = true"
    class="bg-blue-600 hover:bg-blue-700 text-white text-2xl px-4 py-2 rounded font-bold disabled:opacity-50 disabled:cursor-not-allowed"
    x-bind:disabled="<%= !currentUser || postCount >= maxPosts %>"
  >
    Create New Post
  </button>

  <% if (!currentUser) { %>
    <p class="text-red-600 mt-2 font-bold">Please log in to create a post.</p>
  <% } else if (postCount >= maxPosts) { %>
    <p class="text-red-600 mt-2 font-bold">You have reached the maximum of <%= maxPosts %> posts.</p>
  <% } %>

  <div
    x-show="showModal"
    x-cloak
    x-transition
    class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 px-4"
  >
    <div class="bg-white p-6 rounded w-full max-w-96 relative">
      <h3 class="text-lg font-semibold mb-4">Create Post</h3>
      <button
        @click="showModal = false"
        class="text-gray-500 hover:text-gray-700 text-4xl font-bold absolute top-2 right-4"
      >
        &times;
      </button>

      <form @submit.prevent="createPost" class="space-y-2">
        <input
          type="text"
          placeholder="Title"
          class="border p-2 w-full"
          required
          x-model="title"
        />

        <textarea
          x-model="prompt"
          placeholder="Describe what you want to write..."
          class="border p-2 w-full"
        ></textarea>

        <input type="file" @change="handleImageUpload" class="border p-2 w-full" />

        <button
          type="button"
          @click="generateContent"
          class="bg-green-500 text-white px-4 py-2 rounded disabled:opacity-50"
          :disabled="loading || !prompt"
        >
          <span x-show="!loading">Generate Content</span>
          <span x-show="loading">Loading...</span>
        </button>

        <textarea
          placeholder="Content"
          class="border p-2 w-full"
          required
          x-model="postContent"
        ></textarea>

        <button
          type="submit"
          class="bg-blue-600 text-white px-4 py-2 disabled:opacity-50 disabled:cursor-not-allowed"
          x-bind:disabled="<%= !currentUser || postCount >= maxPosts %>"
        >
          Create Post
        </button>
      </form>
    </div>
  </div>
</section>

<script>
function createPostModal() {
  return {
    showModal: false,
    title: "",
    prompt: "",
    image: null,
    postContent: "",
    loading: false,

    handleImageUpload(event) {
      this.image = event.target.files[0] || null;
    },

    async generateContent() {
      if (!this.prompt) return;
      this.loading = true;

      const formData = new FormData();
      formData.append("prompt", this.prompt);
      if (this.image) {
        formData.append("file", this.image);
      }

      try {
        const res = await fetch("/prompt", {
          method: "POST",
          body: formData
        });
        const data = await res.json();
        this.postContent = data.text || "";
      } catch (err) {
        console.error("Error generating content:", err);
      } finally {
        this.loading = false;
      }
    },

    async createPost() {
      if (!this.title || !this.postContent) return;
      try {
        const res = await fetch('/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title: this.title, content: this.postContent })
        });
        if (res.ok) {
          window.location.reload();
        } else {
          const data = await res.json();
          alert(data.error || 'Error creating post');
        }
      } catch (err) {
        alert('Error creating post');
      }
    }
  };
}
</script>
